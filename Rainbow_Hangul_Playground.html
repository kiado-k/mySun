import React, { useState, useRef, useEffect } from 'react';
import { Mic, Eraser, Volume2, Sparkles, Keyboard, X, Info, Music, Music2 } from 'lucide-react';

const App = () => {
  // --- Constants ---
  const BGM_URL = "./suno_bgm.mp3";

  // --- State Management ---
  const [text, setText] = useState("ë¬´ì§€ê°œ í•œê¸€ ë†€ì´í„°");
  const [isListening, setIsListening] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [brushColor, setBrushColor] = useState('#000000'); 
  const [isRainbowMode, setIsRainbowMode] = useState(false);
  const [brushSize] = useState(12);
  const [showInput, setShowInput] = useState(false);
  const [inputText, setInputText] = useState("");
  const [isDrawing, setIsDrawing] = useState(false);
  const [availableVoices, setAvailableVoices] = useState([]);
  const [isBgmOn, setIsBgmOn] = useState(false);

  // --- Refs ---
  const canvasRef = useRef(null);
  const containerRef = useRef(null);
  const recognitionRef = useRef(null);
  const audioRef = useRef(null);
  const lastPos = useRef({ x: 0, y: 0 });

  // 1. Initialization: Audio, Voice & STT
  useEffect(() => {
    // BGM Setup
    const audio = new Audio(BGM_URL);
    audio.loop = true;
    audio.volume = 0.2; // ë°°ê²½ìŒì•… ë³¼ë¥¨ 0.2
    audio.preload = "auto";
    audioRef.current = audio;

    // Speech Recognition Setup (STT)
    try {
      if (typeof window !== 'undefined' && (window.SpeechRecognition || window.webkitSpeechRecognition)) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognitionRef.current = new SpeechRecognition();
        recognitionRef.current.continuous = false;
        recognitionRef.current.lang = 'ko-KR';
        recognitionRef.current.interimResults = false;

        recognitionRef.current.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          setText(transcript.trim());
          clearCanvas(); 
          setIsListening(false);
        };
        recognitionRef.current.onend = () => setIsListening(false);
        recognitionRef.current.onerror = () => setIsListening(false);
      }
    } catch (e) {
      console.error("ìŒì„± ì¸ì‹ ì´ˆê¸°í™” ì‹¤íŒ¨", e);
    }

    const loadVoices = () => {
      if (typeof window !== 'undefined' && window.speechSynthesis) {
        setAvailableVoices(window.speechSynthesis.getVoices());
      }
    };
    loadVoices();
    if (window.speechSynthesis) window.speechSynthesis.onvoiceschanged = loadVoices;

    return () => {
      if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current = null;
      }
    };
  }, []);

  // BGM Toggle
  const toggleBgm = () => {
    if (!audioRef.current) return;
    if (isBgmOn) {
      audioRef.current.pause();
    } else {
      audioRef.current.play().catch(e => console.log("BGM ì¬ìƒ ëŒ€ê¸°: ", e));
    }
    setIsBgmOn(!isBgmOn);
  };

  // 2. Canvas Management
  const initCanvas = () => {
    if (containerRef.current && canvasRef.current) {
      const canvas = canvasRef.current;
      const container = containerRef.current;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = container.offsetWidth * dpr;
      canvas.height = container.offsetHeight * dpr;
      canvas.style.width = `${container.offsetWidth}px`;
      canvas.style.height = `${container.offsetHeight}px`;
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.lineWidth = brushSize;
    }
  };

  useEffect(() => {
    const timer = setTimeout(initCanvas, 300);
    window.addEventListener('resize', initCanvas);
    return () => window.removeEventListener('resize', initCanvas);
  }, [text]);

  // 3. TTS Logic
  const speakText = () => {
    if (!window.speechSynthesis || !text) return;
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    let voices = window.speechSynthesis.getVoices();
    if (voices.length === 0) voices = availableVoices;
    const krVoice = voices.find(v => v.lang.includes('ko') || v.lang.includes('KR'));
    if (krVoice) utterance.voice = krVoice;
    utterance.lang = 'ko-KR';
    utterance.rate = 0.8;
    utterance.onstart = () => setIsSpeaking(true);
    utterance.onend = () => setIsSpeaking(false);
    window.speechSynthesis.speak(utterance);
    
    // Play BGM on first interaction if toggled
    if (isBgmOn && audioRef.current && audioRef.current.paused) {
        audioRef.current.play();
    }
  };

  // 4. Drawing Handlers
  const getCoordinates = (e) => {
    const canvas = canvasRef.current;
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
  };

  const startDrawing = (e) => {
    const { x, y } = getCoordinates(e);
    lastPos.current = { x, y };
    setIsDrawing(true);
  };

  const draw = (e) => {
    if (!isDrawing) return;
    const { x, y } = getCoordinates(e);
    const ctx = canvasRef.current.getContext('2d');
    ctx.beginPath();
    ctx.strokeStyle = isRainbowMode ? `hsl(${Date.now() / 5 % 360}, 75%, 60%)` : brushColor;
    ctx.moveTo(lastPos.current.x, lastPos.current.y);
    ctx.lineTo(x, y);
    ctx.stroke();
    lastPos.current = { x, y };
  };

  const stopDrawing = () => setIsDrawing(false);

  const clearCanvas = () => {
    const ctx = canvasRef.current.getContext('2d');
    ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
  };

  // --- ê°œì„ ëœ ê¸€ì í¬ê¸° ë¡œì§ (ì´ë¯¸ì§€ ì°¸ê³  ë°˜ì˜) ---
  const getDynamicFontSize = () => {
    const len = text.length || 1;
    // 1-2ì: ë”°ë¼ ì“°ê¸° ê°€ì¥ ì¢‹ê²Œ ìµœëŒ€ í¬ê¸° í™•ì¥
    if (len <= 2) return 'clamp(8rem, 45vw, 20rem)'; 
    // 3-5ì: ìº”ë²„ìŠ¤ ê°€ë¡œ ë¹„ìœ¨ì— ë§ì¶° ì¶©ë¶„í•œ í¬ê¸° ìœ ì§€
    if (len <= 5) return 'clamp(5.5rem, 28vw, 13rem)';
    // 6-10ì: ìº”ë²„ìŠ¤ ë„ˆë¹„ë¥¼ ê°€ë“ ì±„ìš°ë©´ì„œë„ ì“°ê¸° í¸í•œ í¬ê¸°
    if (len <= 10) return 'clamp(4rem, 18vw, 9rem)';
    // 11-20ì: ì¤„ë°”ê¿ˆì´ ì¼ì–´ë‚˜ë„ ì¶©ë¶„íˆ í° í¬ê¸° ìœ ì§€
    if (len <= 20) return 'clamp(3rem, 12vw, 6rem)';
    // ê·¸ ì´ìƒì˜ ê¸´ ë¬¸ì¥: ìº”ë²„ìŠ¤ íƒˆì¶œ ë°©ì§€ ë° ìµœì†Œ í¬ê¸° ë³´ì¥
    return 'clamp(2.2rem, 8vw, 4.5rem)';
  };

  const colors = ['#000000', '#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7', '#ec4899'];

  return (
    <div className="flex flex-col items-center w-full h-screen bg-amber-50 font-sans select-none overflow-hidden touch-none fixed inset-0">
      <style>
        {`
          @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
          * { font-family: 'Jua', 'Noto Sans KR', sans-serif; }
          .notebook-bg {
            background-color: #ffffff;
            background-image: 
              linear-gradient(#e5e7eb 1px, transparent 1px),
              linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 40px 40px;
          }
          .guide-text {
            -webkit-text-stroke: 2px #e5e7eb; 
            text-shadow: 2px 2px 0px #fff;
            display: inline-block;
            width: 100%;
            max-width: 95%;
            word-break: break-all;
            line-height: 1.1; /* ì¤„ ê°„ê²©ì„ ì¢í˜€ ë”°ë¼ ì“°ê¸° ë°€ì§‘ë„ í–¥ìƒ */
            text-align: center;
            letter-spacing: -0.01em;
          }
          .rainbow-btn { background: linear-gradient(135deg, #ff0000, #ffff00, #0000ff); }
          .no-scrollbar::-webkit-scrollbar { display: none; }
          @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
          }
          .animate-spin-slow {
            animation: spin-slow 8s linear infinite;
          }
        `}
      </style>

      {/* BGM Toggle Button (ì´ë¯¸ì§€ 2 ì°¸ê³ ) */}
      <button 
        onClick={toggleBgm}
        className={`fixed top-4 right-4 z-[60] flex items-center gap-2 px-3 py-2 rounded-full backdrop-blur-md shadow-lg transition-all active:scale-95 border border-white/20 ${isBgmOn ? 'bg-white/90 text-amber-600' : 'bg-gray-500/80 text-white'}`}
      >
        {isBgmOn ? <Music size={18} className="animate-spin-slow" /> : <Music2 size={18} />}
        <span className="text-[11px] font-bold tracking-tighter">{isBgmOn ? 'BGM ON' : 'BGM OFF'}</span>
      </button>

      {/* Header */}
      <div className="flex items-center gap-2 pt-4 pb-2">
        <span className="text-2xl">ğŸ£</span>
        <h1 className="text-xl font-bold text-amber-600">ë¬´ì§€ê°œ í•œê¸€ë†€ì´</h1>
      </div>

      {/* Tool Panel */}
      <div className="w-full px-4 flex flex-col gap-2 mb-2">
        <div className="grid grid-cols-4 gap-2 w-full max-w-4xl mx-auto">
          <button onClick={() => { 
              if(!recognitionRef.current) { setShowInput(true); return; }
              if(isListening) recognitionRef.current.stop();
              else {
                  try { recognitionRef.current.start(); setIsListening(true); } 
                  catch(e) { setShowInput(true); }
              }
            }} 
            className={`py-3 rounded-2xl border-2 flex flex-col items-center justify-center shadow-sm transition-all active:scale-95 ${isListening ? 'bg-red-50 border-red-400 text-red-500 animate-pulse' : 'bg-white border-red-100 text-red-400'}`}>
            <Mic size={24} />
            <span className="text-[10px] sm:text-xs mt-1">ë§í•˜ê¸°</span>
          </button>
          
          <button onClick={() => setShowInput(true)} 
            className="py-3 rounded-2xl border-2 bg-white border-purple-100 text-purple-400 flex flex-col items-center justify-center shadow-sm active:scale-95">
            <Keyboard size={24} />
            <span className="text-[10px] sm:text-xs mt-1">ì…ë ¥</span>
          </button>
          
          <button onClick={speakText} disabled={isSpeaking}
            className={`py-3 rounded-2xl border-2 flex flex-col items-center justify-center shadow-sm transition-all active:scale-95 ${isSpeaking ? 'bg-blue-50 border-blue-400 text-blue-500' : 'bg-white border-blue-100 text-blue-400'}`}>
            <Volume2 size={24} className={isSpeaking ? 'animate-bounce' : ''} />
            <span className="text-[10px] sm:text-xs mt-1">ì½ê¸°</span>
          </button>
          
          <button onClick={clearCanvas} 
            className="py-3 rounded-2xl border-2 bg-white border-orange-100 text-orange-400 flex flex-col items-center justify-center shadow-sm active:scale-95">
            <Eraser size={24} />
            <span className="text-[10px] sm:text-xs mt-1">ì§€ìš°ê¸°</span>
          </button>
        </div>

        {/* Color Palette */}
        <div className="bg-white rounded-2xl border-2 border-amber-200 p-2 flex items-center justify-center shadow-sm max-w-4xl mx-auto w-full">
          <div className="flex gap-2.5 sm:gap-4 overflow-x-auto no-scrollbar py-1">
            {colors.map((c) => (
              <button key={c} onClick={() => { setIsRainbowMode(false); setBrushColor(c); }}
                className={`w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 shrink-0 transition-transform ${!isRainbowMode && brushColor === c ? 'border-gray-800 scale-110 shadow-md' : 'border-transparent'}`}
                style={{ backgroundColor: c }} />
            ))}
            <button onClick={() => setIsRainbowMode(true)}
              className={`w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 shrink-0 flex items-center justify-center rainbow-btn transition-transform ${isRainbowMode ? 'border-gray-800 scale-110 shadow-md' : 'border-transparent'}`}>
              <Sparkles size={18} className="text-white" />
            </button>
          </div>
        </div>
      </div>

      {/* Writing Area (ì´ë¯¸ì§€ ì°¸ê³ : ê°€ë¡œë¡œ ê½‰ ì°¨ë„ë¡ ì„¤ê³„) */}
      <div className="flex-1 w-full px-4 pb-2 min-h-0">
        <div className="w-full h-full bg-white rounded-3xl border-4 border-amber-200 overflow-hidden shadow-xl relative">
          <div ref={containerRef} className="notebook-bg w-full h-full relative flex items-center justify-center p-4">
            
            <div className="absolute inset-0 flex items-center justify-center z-0 pointer-events-none p-4 overflow-hidden">
               {/* ëˆˆê¸ˆ ê°€ì´ë“œ íŒ¨í„´ */}
               <div className="absolute inset-0 opacity-10 pointer-events-none" 
                 style={{ 
                   backgroundImage: 'linear-gradient(to right, #000 1.5px, transparent 1.5px), linear-gradient(to bottom, #000 1.5px, transparent 1.5px)',
                   backgroundSize: '100% 100%',
                   backgroundPosition: 'center'
                 }} 
               />
              <span className="guide-text" 
                    style={{ 
                      fontSize: getDynamicFontSize(), 
                      color: 'transparent',
                    }}>
                {text}
              </span>
            </div>

            <canvas
              ref={canvasRef}
              className="absolute top-0 left-0 w-full h-full z-10 cursor-crosshair"
              style={{ touchAction: 'none' }} 
              onMouseDown={startDrawing}
              onMouseMove={draw}
              onMouseUp={stopDrawing}
              onMouseLeave={stopDrawing}
              onTouchStart={startDrawing}
              onTouchMove={draw}
              onTouchEnd={stopDrawing}
            />
          </div>
        </div>
      </div>
      
      {/* Footer (ì´ë¯¸ì§€ 2ì˜ ì €ì‘ê¶Œ í‘œì‹œ ì ìš©) */}
      <div className="flex flex-col items-center gap-1 py-3">
        <div className="flex items-center gap-1.5 text-amber-500/80 bg-amber-100/50 px-4 py-1 rounded-full mb-1">
          <Info size={12} />
          <p className="text-[10px] font-medium">ì•„ì´í°ì€ ì¸¡ë©´ ì§„ë™ ìŠ¤ìœ„ì¹˜ë¥¼ êº¼ì•¼ ì†Œë¦¬ê°€ ë“¤ë ¤ìš”!</p>
        </div>
        <p className="text-[10px] text-gray-400 font-medium tracking-tight">
          <span className="text-gray-500 font-bold">Music by Suno</span> | Font: ë°°ë‹¬ì˜ë¯¼ì¡± ì£¼ì•„, Noto Sans
        </p>
        <p className="text-[10px] text-gray-400 opacity-70">Â© 2026 kiado-k. All rights reserved.</p>
      </div>

      {/* Input Modal */}
      {showInput && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-6" onClick={() => setShowInput(false)}>
          <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-bold text-gray-800">ë‹¨ì–´ ì…ë ¥í•˜ê¸°</h3>
              <button onClick={() => setShowInput(false)} className="text-gray-400 hover:text-gray-600 transition-colors"><X size={24}/></button>
            </div>
            <form onSubmit={(e) => { e.preventDefault(); if(inputText.trim()){ setText(inputText); clearCanvas(); setShowInput(false); setInputText(""); } }}>
              <input autoFocus type="text" value={inputText} onChange={(e) => setInputText(e.target.value)}
                className="w-full border-b-4 border-amber-200 rounded-none p-3 text-2xl text-center mb-6 focus:outline-none focus:border-amber-400 transition-all"
                placeholder="ì˜ˆ: ì•ˆë…• ì¹œêµ¬ì•¼" />
              <button type="submit" className="w-full bg-amber-400 hover:bg-amber-500 text-white rounded-2xl py-4 text-xl font-bold shadow-lg shadow-amber-200 active:scale-95 transition-all">
                ë³´ì—¬ì£¼ê¸°
              </button>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;