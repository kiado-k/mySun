<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¬´ì§€ê°œ í•œê¸€ ë†€ì´í„°</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;700&display=swap');
        
        body {
            font-family: 'Jua', 'Noto Sans KR', sans-serif;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
        }

        .notebook-bg {
            background-color: #ffffff;
            background-image: 
                linear-gradient(#e5e7eb 1px, transparent 1px),
                linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .guide-text {
            -webkit-text-stroke: 2px #e5e7eb; 
            text-shadow: 2px 2px 0px #fff;
            display: inline-block;
            width: 100%;
            max-width: 95%;
            word-break: break-all;
            line-height: 1.1;
            text-align: center;
            letter-spacing: -0.01em;
            color: transparent;
        }

        .rainbow-btn {
            background: linear-gradient(135deg, #ff0000, #ffff00, #0000ff);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .animate-spin-slow {
            animation: spin-slow 8s linear infinite;
        }

        canvas {
            cursor: crosshair;
        }

        /* Modal animation */
        .modal-enter {
            animation: zoomIn 0.2s ease-out;
        }

        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-amber-50 h-screen overflow-hidden fixed inset-0">

    <!-- Main Container -->
    <div class="flex flex-col items-center w-full h-full">
        
        <!-- BGM Toggle Button -->
        <button id="bgm-btn" class="fixed top-4 right-4 z-[60] flex items-center gap-2 px-3 py-2 rounded-full backdrop-blur-md shadow-lg transition-all active:scale-95 border border-white/20 bg-gray-500/80 text-white">
            <i data-lucide="music-2" id="bgm-icon"></i>
            <span class="text-[11px] font-bold tracking-tighter" id="bgm-text">BGM OFF</span>
        </button>

        <!-- Header -->
        <div class="flex items-center gap-2 pt-4 pb-2">
            <span class="text-2xl">ğŸ£</span>
            <h1 class="text-xl font-bold text-amber-600">ë¬´ì§€ê°œ í•œê¸€ ë†€ì´í„°</h1>
        </div>

        <!-- Tool Panel -->
        <div class="w-full px-4 flex flex-col gap-2 mb-2 max-w-4xl">
            <div class="grid grid-cols-4 gap-2 w-full">
                <!-- Mic -->
                <button id="mic-btn" class="py-3 rounded-2xl border-2 bg-white border-red-100 text-red-400 flex flex-col items-center justify-center shadow-sm transition-all active:scale-95">
                    <i data-lucide="mic"></i>
                    <span class="text-[10px] sm:text-xs mt-1">ë§í•˜ê¸°</span>
                </button>
                <!-- Keyboard -->
                <button id="kbd-btn" class="py-3 rounded-2xl border-2 bg-white border-purple-100 text-purple-400 flex flex-col items-center justify-center shadow-sm active:scale-95">
                    <i data-lucide="keyboard"></i>
                    <span class="text-[10px] sm:text-xs mt-1">ì…ë ¥</span>
                </button>
                <!-- Speak -->
                <button id="speak-btn" class="py-3 rounded-2xl border-2 bg-white border-blue-100 text-blue-400 flex flex-col items-center justify-center shadow-sm transition-all active:scale-95">
                    <i data-lucide="volume-2" id="speak-icon"></i>
                    <span class="text-[10px] sm:text-xs mt-1">ì½ê¸°</span>
                </button>
                <!-- Eraser -->
                <button id="clear-btn" class="py-3 rounded-2xl border-2 bg-white border-orange-100 text-orange-400 flex flex-col items-center justify-center shadow-sm active:scale-95">
                    <i data-lucide="eraser"></i>
                    <span class="text-[10px] sm:text-xs mt-1">ì§€ìš°ê¸°</span>
                </button>
            </div>

            <!-- Color Palette -->
            <div class="bg-white rounded-2xl border-2 border-amber-200 p-2 flex items-center justify-center shadow-sm w-full">
                <div id="color-list" class="flex gap-2.5 sm:gap-4 overflow-x-auto no-scrollbar py-1">
                    <!-- Colors will be injected here -->
                </div>
            </div>
        </div>

        <!-- Writing Area -->
        <div class="flex-1 w-full px-4 pb-2 min-h-0 max-w-6xl">
            <div id="canvas-container" class="w-full h-full bg-white rounded-3xl border-4 border-amber-200 overflow-hidden shadow-xl relative">
                <div class="notebook-bg w-full h-full relative flex items-center justify-center p-4">
                    
                    <div class="absolute inset-0 flex items-center justify-center z-0 pointer-events-none p-4 overflow-hidden">
                        <!-- Grid lines -->
                        <div class="absolute inset-0 opacity-10 pointer-events-none" 
                             style="background-image: linear-gradient(to right, #000 1.5px, transparent 1.5px), linear-gradient(to bottom, #000 1.5px, transparent 1.5px); background-size: 100% 100%; background-position: center;">
                        </div>
                        <span id="guide-text" class="guide-text">ë¬´ì§€ê°œ í•œê¸€ ë†€ì´í„°</span>
                    </div>

                    <canvas id="writing-canvas" class="absolute top-0 left-0 w-full h-full z-10"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="flex flex-col items-center gap-1 py-3">
            <div class="flex items-center gap-1.5 text-amber-500/80 bg-amber-100/50 px-4 py-1 rounded-full mb-1">
                <i data-lucide="info" size="12"></i>
                <p class="text-[10px] font-medium">ì•„ì´í°ì€ ì¸¡ë©´ ì§„ë™ ìŠ¤ìœ„ì¹˜ë¥¼ êº¼ì•¼ ì†Œë¦¬ê°€ ë“¤ë ¤ìš”!</p>
            </div>
            <p class="text-[10px] text-gray-400 font-medium tracking-tight">
                <span class="text-gray-500 font-bold">Music by Suno</span> | Font: ë°°ë‹¬ì˜ë¯¼ì¡± ì£¼ì•„, Noto Sans
            </p>
            <p class="text-[10px] text-gray-400 opacity-70">Â© 2026 kiado-k. All rights reserved.</p>
        </div>
    </div>

    <!-- Input Modal -->
    <div id="input-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-6">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl modal-enter">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">ë‹¨ì–´ ì…ë ¥í•˜ê¸°</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i data-lucide="x" size="24"></i>
                </button>
            </div>
            <form id="input-form">
                <input id="word-input" type="text" autofocus
                    class="w-full border-b-4 border-amber-200 rounded-none p-3 text-2xl text-center mb-6 focus:outline-none focus:border-amber-400 transition-all"
                    placeholder="ì˜ˆ: ì•ˆë…• ì¹œêµ¬ì•¼">
                <button type="submit" class="w-full bg-amber-400 hover:bg-amber-500 text-white rounded-2xl py-4 text-xl font-bold shadow-lg active:scale-95 transition-all">
                    ë³´ì—¬ì£¼ê¸°
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const BGM_URL = "./suno_bgm.mp3";
        let state = {
            text: "ë¬´ì§€ê°œ í•œê¸€ ë†€ì´í„°",
            brushColor: "#000000",
            isRainbowMode: false,
            brushSize: 12,
            isDrawing: false,
            isListening: false,
            isSpeaking: false,
            isBgmOn: false,
            lastPos: { x: 0, y: 0 }
        };

        const colors = ['#000000', '#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7', '#ec4899'];

        // --- DOM Elements ---
        const canvas = document.getElementById('writing-canvas');
        const container = document.getElementById('canvas-container');
        const guideText = document.getElementById('guide-text');
        const bgmBtn = document.getElementById('bgm-btn');
        const bgmIcon = document.getElementById('bgm-icon');
        const bgmText = document.getElementById('bgm-text');
        const micBtn = document.getElementById('mic-btn');
        const kbdBtn = document.getElementById('kbd-btn');
        const speakBtn = document.getElementById('speak-btn');
        const speakIcon = document.getElementById('speak-icon');
        const clearBtn = document.getElementById('clear-btn');
        const modal = document.getElementById('input-modal');
        const closeModal = document.getElementById('close-modal');
        const inputForm = document.getElementById('input-form');
        const wordInput = document.getElementById('word-input');
        const colorList = document.getElementById('color-list');

        let audio = new Audio(BGM_URL);
        audio.loop = true;
        audio.volume = 0.2;

        // --- Initialization ---
        function init() {
            lucide.createIcons();
            renderColorPalette();
            setupEventListeners();
            resizeCanvas();
            updateDisplay();
        }

        function renderColorPalette() {
            colors.forEach(color => {
                const btn = document.createElement('button');
                btn.className = 'w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 shrink-0 transition-transform border-transparent';
                btn.style.backgroundColor = color;
                btn.onclick = () => selectColor(color);
                colorList.appendChild(btn);
            });

            // Rainbow Button
            const rainbowBtn = document.createElement('button');
            rainbowBtn.className = 'w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 shrink-0 flex items-center justify-center rainbow-btn transition-transform border-transparent';
            rainbowBtn.innerHTML = '<i data-lucide="sparkles" class="text-white w-4 h-4 sm:w-[18px] sm:h-[18px]"></i>';
            rainbowBtn.onclick = () => selectRainbowMode();
            colorList.appendChild(rainbowBtn);
            lucide.createIcons();
        }

        // --- Logic Functions ---
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = state.brushSize;
        }

        function updateDisplay() {
            guideText.innerText = state.text;
            guideText.style.fontSize = getDynamicFontSize(state.text);
            clearCanvas();
        }

        function getDynamicFontSize(txt) {
            const len = txt.length || 1;
            if (len <= 2) return 'clamp(8rem, 45vw, 20rem)'; 
            if (len <= 5) return 'clamp(5.5rem, 28vw, 13rem)';
            if (len <= 10) return 'clamp(4rem, 18vw, 9rem)';
            if (len <= 20) return 'clamp(3rem, 12vw, 6rem)';
            return 'clamp(2.2rem, 8vw, 4.5rem)';
        }

        function selectColor(color) {
            state.brushColor = color;
            state.isRainbowMode = false;
            updatePaletteUI();
        }

        function selectRainbowMode() {
            state.isRainbowMode = true;
            updatePaletteUI();
        }

        function updatePaletteUI() {
            const btns = colorList.querySelectorAll('button');
            btns.forEach((btn, index) => {
                if (index < colors.length) {
                    const isSelected = !state.isRainbowMode && state.brushColor === colors[index];
                    btn.classList.toggle('border-gray-800', isSelected);
                    btn.classList.toggle('scale-110', isSelected);
                    btn.classList.toggle('shadow-md', isSelected);
                } else {
                    btn.classList.toggle('border-gray-800', state.isRainbowMode);
                    btn.classList.toggle('scale-110', state.isRainbowMode);
                    btn.classList.toggle('shadow-md', state.isRainbowMode);
                }
            });
        }

        function clearCanvas() {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // --- Input & STT ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'ko-KR';
            recognition.onresult = (e) => {
                const result = e.results[0][0].transcript;
                state.text = result.trim();
                updateDisplay();
                setMicState(false);
            };
            recognition.onend = () => setMicState(false);
            recognition.onerror = () => setMicState(false);
        }

        function toggleMic() {
            if (!recognition) {
                openModal();
                return;
            }
            if (state.isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                    setMicState(true);
                } catch(e) { openModal(); }
            }
        }

        function setMicState(val) {
            state.isListening = val;
            micBtn.classList.toggle('bg-red-50', val);
            micBtn.classList.toggle('border-red-400', val);
            micBtn.classList.toggle('text-red-500', val);
            micBtn.classList.toggle('animate-pulse', val);
        }

        // --- TTS ---
        function speak() {
            if (!window.speechSynthesis || !state.text) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(state.text);
            const voices = window.speechSynthesis.getVoices();
            const krVoice = voices.find(v => v.lang.includes('ko') || v.lang.includes('KR'));
            if (krVoice) utterance.voice = krVoice;
            utterance.lang = 'ko-KR';
            utterance.rate = 0.8;
            utterance.onstart = () => setSpeakState(true);
            utterance.onend = () => setSpeakState(false);
            window.speechSynthesis.speak(utterance);
            
            if (state.isBgmOn && audio.paused) audio.play();
        }

        function setSpeakState(val) {
            state.isSpeaking = val;
            speakBtn.classList.toggle('bg-blue-50', val);
            speakBtn.classList.toggle('border-blue-400', val);
            speakBtn.classList.toggle('text-blue-500', val);
            speakIcon.classList.toggle('animate-bounce', val);
        }

        // --- BGM ---
        function toggleBgm() {
            if (state.isBgmOn) {
                audio.pause();
                bgmBtn.classList.replace('bg-white/90', 'bg-gray-500/80');
                bgmBtn.classList.replace('text-amber-600', 'text-white');
                bgmIcon.classList.remove('animate-spin-slow');
                bgmText.innerText = 'BGM OFF';
            } else {
                audio.play().catch(() => {});
                bgmBtn.classList.replace('bg-gray-500/80', 'bg-white/90');
                bgmBtn.classList.replace('text-white', 'text-amber-600');
                bgmIcon.classList.add('animate-spin-slow');
                bgmText.innerText = 'BGM ON';
            }
            state.isBgmOn = !state.isBgmOn;
        }

        // --- Drawing Handlers ---
        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function handleStart(e) {
            const coords = getCoords(e);
            state.lastPos = coords;
            state.isDrawing = true;
        }

        function handleMove(e) {
            if (!state.isDrawing) return;
            const coords = getCoords(e);
            const ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.strokeStyle = state.isRainbowMode ? `hsl(${Date.now() / 5 % 360}, 75%, 60%)` : state.brushColor;
            ctx.moveTo(state.lastPos.x, state.lastPos.y);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
            state.lastPos = coords;
        }

        function handleEnd() {
            state.isDrawing = false;
        }

        // --- Modal ---
        function openModal() { modal.classList.replace('hidden', 'flex'); wordInput.focus(); }
        function closeModalWindow() { modal.classList.replace('flex', 'hidden'); }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            window.addEventListener('resize', () => { resizeCanvas(); updateDisplay(); });
            
            // Mouse
            canvas.addEventListener('mousedown', handleStart);
            canvas.addEventListener('mousemove', handleMove);
            window.addEventListener('mouseup', handleEnd);

            // Touch
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleStart(e); }, { passive: false });
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e); }, { passive: false });
            canvas.addEventListener('touchend', handleEnd);

            // Buttons
            bgmBtn.onclick = toggleBgm;
            micBtn.onclick = toggleMic;
            kbdBtn.onclick = openModal;
            speakBtn.onclick = speak;
            clearBtn.onclick = clearCanvas;
            closeModal.onclick = closeModalWindow;
            modal.onclick = (e) => { if (e.target === modal) closeModalWindow(); };

            inputForm.onsubmit = (e) => {
                e.preventDefault();
                const val = wordInput.value.trim();
                if (val) {
                    state.text = val;
                    updateDisplay();
                    closeModalWindow();
                    wordInput.value = '';
                }
            };
        }

        // Start App
        window.onload = init;
    </script>
</body>
</html>
